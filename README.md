# DY's Virtual Machine



[TOC]



## I. Introduction

  This is a toy virtual machine created by me for fun. It can support only 64-bit integral operations. It has 15 register files which share the same names with those in *__x86-64 ISA__* (`%rax`, `%rcx`, ...). There exists some special registers such as *condition code register*, *program counter* and *status register*. The memory size is currently 1MB, and this can be modified in `vm.c`. The controller and ALU are implemented through functions written in `vm.c`.

### i. Registers 

| No.  | ID   | Function                                 |
| ---- | ---- | ---------------------------------------- |
| 0    | %rax | Storing the return value. Saved by caller. |
| 1    | %rcx | The 4th parameter.                       |
| 2    | %rdx | The 3rd parameter.                       |
| 3    | %rbx | Saved by callee.                         |
| 4    | %rsp | Pointer to stack.                        |
| 5    | %rbp | Saved by callee.                         |
| 6    | %rsi | The 2nd parameter.                       |
| 7    | %rdi | The 1st parameter.                       |
| 8    | %r8  | The 5th parameter.                       |
| 9    | %r9  | The 6th parameter.                       |
| A    | %r10 | Saved by caller.                         |
| B    | %r11 | Saved by callee.                         |
| C    | %r12 | Saved by callee.                         |
| D    | %r13 | Saved by callee.                         |
| E    | %r14 | Saved by callee.                         |

### ii. Special Registers

* **CC**: Condition Code, which stores the values of `CF(carry)`, `ZF(zero)`, `SF(signed)`, `OF(overflow)`.

* **PC**: Program counter.

* **Status**: Store the current status of the machine.

  | No.  | Value | Implication                              |
  | ---- | ----- | ---------------------------------------- |
  | 0    | OK    | normal operations                        |
  | 1    | HLT   | halted (applys when encountering instruction `halt`) |
  | 2    | INS   | illegal instruction                      |
  | 3    | ADR   | illegal memory address                   |
  | 4    | REG   | illegal register id                      |
  | 5    | LOG   | logic errors                             |

### iii. Memory

  The current memory size is 1MB (`0x100000`). The whole memory is divided into three sections: *stack section*, *program section* and *data section*. 

  *Stack section* is for stack operations which starts from `0x0` to `0x3FFFF`, and the value of `%rsp` should be among it. 

  *Program section* is the place where a running process is. It starts from `0x40000` to `0x7FFFF`. the value of **PC** must be in this area.

  *Data section* is space for running data. It ranges from `0x80000` to `0xFFFFF`. All data generated by the running process could be stored here.



## II. Instruction Set Architecture

This is the instruction list of *DY64 ISA*. In which,

* I = immediate number, starting with character `$` (e.g. `$123`, `$65536`).
* R = register id, ranging from `0` to `0xF` (`0xF` stands for none register access) (e.g. `%rax`).
* M = memory address, and the format is like `I(R,R,C)` (e.g. `8(%rax,%rcx,4)`, `(%rdx)`,`(,%rbx,4)` or `128(,,)`).
* L = label, is allowed to start with `.` (e.g. `.L1`).

| Code | Identifier | Type (num of args) | Note                                     |
| ---- | ---------- | ------------------ | ---------------------------------------- |
| `00` | `halt`     | 0                  | Make the **status** be `HLT`.            |
| `01` | `nop`      | 0                  |                                          |
| `10` | `rrmov`    | 2: RR              | The 1st paratmeter is source and the 2nd is destination. So do `cmov`s. |
| `11` | `cmove`    | 2: RR              |                                          |
| `12` | `cmovne`   | 2: RR              |                                          |
| `13` | `cmovs`    | 2: RR              |                                          |
| `14` | `cmovns`   | 2: RR              |                                          |
| `15` | `cmovg`    | 2: RR              |                                          |
| `16` | `cmovge`   | 2: RR              |                                          |
| `17` | `cmovl`    | 2: RR              |                                          |
| `18` | `cmovle`   | 2: RR              |                                          |
| `19` | `cmova`    | 2: RR              |                                          |
| `1A` | `cmovae`   | 2: RR              |                                          |
| `1B` | `cmovb`    | 2: RR              |                                          |
| `1C` | `cmovbe`   | 2: RR              |                                          |
| `20` | `irmov`    | 2: IR              |                                          |
| `30` | `rmmov`    | 2: RM              | R -> M                                   |
| `31` | `mrmov`    | 2: MR              | M -> R                                   |
| `40` | `add`      | 2: RR              | The result will be stored in the last register. |
| `41` | `sub`      | 2: RR              |                                          |
| `42` | `and`      | 2: RR              |                                          |
| `43` | `or`       | 2: RR              |                                          |
| `44` | `xor`      | 2: RR              |                                          |
| `45` | `sal`      | 2: RR              |                                          |
| `46` | `sar`      | 2: RR              |                                          |
| `47` | `shr`      | 2: RR              |                                          |
| `48` | `mul`      | 2: RR              |                                          |
| `49` | `inc`      | 1: R               |                                          |
| `4A` | `dec`      | 1: R               |                                          |
| `4B` | `neg`      | 1: R               |                                          |
| `4C` | `not`      | 1: R               |                                          |
| `60` | `cqto`     | 0                  |                                          |
| `70` | `lea`      | 2: MR              |                                          |
| `80` | `cmp`      | 2: RR              |                                          |
| `81` | `test`     | 2: RR              |                                          |
| `90` | `jmp`      | 1: L               |                                          |
| `91` | `je`       | 1: L               |                                          |
| `92` | `jne`      | 1: L               |                                          |
| `93` | `js`       | 1: L               |                                          |
| `94` | `jns`      | 1: L               |                                          |
| `95` | `jg`       | 1: L               |                                          |
| `96` | `jge`      | 1: L               |                                          |
| `97` | `jl`       | 1: L               |                                          |
| `98` | `jle`      | 1: L               |                                          |
| `99` | `ja`       | 1: L               |                                          |
| `9A` | `jae`      | 1: L               |                                          |
| `9B` | `jb`       | 1: L               |                                          |
| `9C` | `jbe`      | 1: L               |                                          |
| `9D` | `call`     | 1: L               |                                          |
| `A0` | `ret`      | 0                  |                                          |
| `B0` | `push`     | 1: R               |                                          |
| `B1` | `pop`      | 1: R               |                                          |
| `C0` | `iecho`    | 1: R               |                                          |
| `C1` | `echo`     | 1: R               |                                          |
